# Chapter 20: Designing for Performance (성능을 위한 설계)

## 핵심 질문

깔끔한 설계와 좋은 성능은 상충하는가? 설계 단계에서 성능을 어떻게 고려해야 하는가?

---

## 1. 깔끔한 설계와 성능의 관계

> **깔끔한 설계와 좋은 성능은 근본적으로 상충하지 않는다.**

단순하고 깔끔한 코드가 종종 빠른 코드이기도 하다. 복잡한 코드는 최적화하기도 어렵다.

하지만 성능을 **완전히 무시**하는 것도 문제다. 핵심은 **설계 단계에서** 성능을 고려하는 것이다.

---

## 2. 설계 단계에서 성능 고려하기

### 2.1 빈번한 연산을 식별하라

> 설계 단계에서 가장 먼저 할 일은 **"어떤 연산이 가장 자주 실행되는가?"** 를 파악하는 것이다.

```
텍스트 에디터의 빈번한 연산:
- 문자 삽입/삭제 → 초당 수십~수백 회
- 화면 렌더링 → 초당 60회
- 파일 저장 → 수 분에 한 번
- 파일 열기 → 드물게

→ 문자 삽입/삭제와 렌더링이 가장 빈번 → 이 연산이 빠르도록 설계
```

### 2.2 핵심 경로(Critical Path)를 최적화하라

- 가장 자주 실행되는 연산(**일반적 경우, common case**)을 빠르게 설계한다
- 드문 경우(special case)가 느려도 괜찮다

```python
# 좋은 설계: 일반적 경우(캐시 적중)를 위해 최적화
def get_user(user_id):
    # 일반적 경우: 캐시에 있음 (95%의 요청)
    cached = cache.get(user_id)
    if cached:
        return cached  # 빠른 경로

    # 드문 경우: DB 조회 (5%의 요청)
    user = db.query("SELECT * FROM users WHERE id = ?", user_id)
    cache.set(user_id, user)
    return user
```

---

## 3. 근본적 해결 vs 특수 케이스 최적화

### 3.1 근본적 해결 (Fundamental Fix)

설계를 바꿔서 일반적 경우가 **본질적으로** 빠르도록 만든다.

```python
# 근본적 해결: 데이터 구조 변경
# 리스트 → 해시맵으로 바꿔서 조회가 O(n) → O(1)
users_by_id = {user.id: user for user in users}
user = users_by_id[target_id]  # O(1)
```

### 3.2 특수 케이스 최적화 (Special-Case Fix)

일반적 설계는 유지하면서, 특정 시나리오를 감지하여 빠른 경로로 우회한다.

```python
# 특수 케이스: 빈 리스트를 먼저 체크
def find_common_elements(list_a, list_b):
    if not list_a or not list_b:  # 특수 케이스
        return []
    # 일반적 로직...
```

> **핵심 통찰**: **근본적 해결을 선호하라.** 근본적 해결은 단순하고 유지보수하기 쉽다. 특수 케이스 최적화는 복잡성을 추가하며(Special-General Mixture), 정말 필요한 경우에만 사용해야 한다.

---

## 4. 성능을 위해 설계를 희생하지 마라

- 대부분의 성능 문제는 **설계를 희생하지 않고** 해결할 수 있다
- 성능 최적화가 설계를 나쁘게 만든다면, 최적화 코드를 **격리**하고 **문서화**하라
- **측정** 없이 최적화하지 마라 (추측은 거의 틀린다)

---

## 요약

- 깔끔한 설계와 좋은 성능은 **상충하지 않는다**.
- 설계 단계에서 **빈번한 연산**을 식별하고, 이 연산이 빠르도록 설계하라.
- **근본적 해결**(설계 변경)을 특수 케이스 최적화보다 선호하라.
- 성능을 위해 설계를 희생해야 한다면, 해당 코드를 **격리하고 문서화**하라.
- **측정 먼저, 최적화 나중.**

---

## 다음 챕터와의 연결

Chapter 21 **"Decide What Matters (무엇이 중요한지 결정하라)"** 에서는 성능뿐 아니라 모든 설계 결정에서 "무엇이 중요한가"를 판단하는 원칙을 다룬다. 중요한 것을 강조하고, 덜 중요한 것을 숨기는 것이 좋은 설계의 본질이다.
